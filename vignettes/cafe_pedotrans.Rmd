---
title: "Modelagem da capacidade de suporte de carga de latossolos com diferente mineralogia"
author: >
  [Walmes Marques Zeviani](http://lattes.cnpq.br/4410617539281650) &
  [Carla Eloize Carducci](http://lattes.cnpq.br/3585988593213083)
date: '`r format(Sys.Date(), format = "%d de %B de %Y")`'
vignette: >
  %\VignetteIndexEntry{Modelagem da capacidade de suporte de carga de latossolos com diferente mineralogia}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
source("config/setup.R")
```

## Exploratory data analysis

```{r, eval = FALSE, include = FALSE}
devtools::load_all()
```
```{r, results = "hide", message = FALSE, error = FALSE, warning = FALSE}
#-----------------------------------------------------------------------
# Load packages.

rm(list = objects())

library(EACS)
library(lmerTest)
library(lme4)
library(emmeans)
library(car)
library(tidyverse)

# To compare curves with Wald F test statistic.
compare_curves <- function(index,
                           levels = NULL,
                           L = L,
                           ords = list(ord0, ord1)) {
    J <- L[index, , drop = FALSE]
    K <- wzRfun::apc(J, lev = levels)
    f_test <- apply(K[, , drop = FALSE],
                    MARGIN = 1,
                    FUN = function(Ki) {
                        U <- lapply(ords,
                                    function(ord) {
                                        Ki %*% diag(ord)
                                    })
                        U <- do.call(rbind, U)
                        f_test <-
                            linearHypothesis(model = m1,
                                             hypothesis.matrix = U,
                                             test = "F")
                        tail(f_test[, c("F", "Pr(>F)")], n = 1)
                    })
    f_test <- do.call(what = rbind, args = f_test)
    cbind(contrast = rownames(f_test), f_test)
}
```
```{r, include = FALSE}
devtools::load_all()
```
```{r}
# Dataset.
da <- as_tibble(cafe_pedotrans)
str(da)

# Creates variables to represent different experimental units sizes.
da <- da %>%
    mutate(ue = NULL,
           ue1 = interaction(solo, rep),
           ue2 = interaction(solo, rep, posi),
           ue3 = interaction(solo, rep, posi, prof))

# Recode factor levels.
levels(da$posi) <- c("Interrow", "Row")
s <- c(KH = "Kaolinitic Haplustox", GA = "Gibbsitic Acrustox")
levels(da$solo) <- names(s)
levels(da$prof)

# Recode levels.
da$trt <- with(da, interaction(solo, posi, as.integer(prof), sep = "Â·"))

# Numeric summary.
summary(da)

# Count of experimental points.
ftable(tensao ~ solo + posi + prof, data = da)

# Creates variables in the log scale.
da$logtensao <- log10(da$tensao)
da$logppc <- log10(da$ppc)

# Text to be used as axis label.
axis_text <- list(
    pcc = expression(Log[10] ~ (sigma * "p, kPa") - "Preconsolidation pressure"),
    tensao = expression(Log[10] ~ (Psi * "m, kPa") - "Matric tension"),
    posi = "Position",
    solo = "Soil",
    prof = "Depth")

# Experimental units profile in each experimental point.
ggplot(data = da,
       mapping = aes(x = tensao, y = ppc, color = rep, group = rep)) +
    facet_wrap(facets = ~trt) +
    geom_point(show.legend = FALSE) +
    geom_line(show.legend = FALSE) +
    scale_x_log10() +
    scale_y_log10() +
    labs(x = axis_text$tensao,
         y = axis_text$pcc)

# Mean profile in each experimental point. The curve is the second order
# polynomial model fitted to the sample data only to check if it
# captures properly the trend in data.
ggplot(data = da,
       mapping = aes(x = tensao, y = ppc)) +
    facet_wrap(facets = ~trt) +
    geom_point() +
    stat_summary(geom = "line", fun.y = "mean") +
    geom_smooth(method = "lm",
                formula = y ~ poly(x, degree = 2),
                se = FALSE) +
    scale_x_log10() +
    scale_y_log10() +
    labs(x = axis_text$tensao,
         y = axis_text$pcc)

# Differnce in position mean profile conditional to other factors.
ggplot(data = da,
       mapping = aes(x = tensao, y = ppc, color = posi)) +
    facet_grid(facets = prof ~ solo) +
    geom_point() +
    stat_summary(geom = "line", fun.y = "mean") +
    scale_x_log10() +
    scale_y_log10() +
    labs(x = axis_text$tensao,
         y = axis_text$pcc,
         color = axis_text$posi)

# Differnce in soil mean profile conditional to other factors.
ggplot(data = da,
       mapping = aes(x = tensao, y = ppc, color = solo)) +
    facet_grid(facets = prof ~ posi) +
    geom_point() +
    stat_summary(geom = "line", fun.y = "mean") +
    scale_x_log10() +
    scale_y_log10() +
    labs(x = axis_text$tensao,
         y = axis_text$pcc,
         color = axis_text$solo)
```

## Linear mixed model

Based on exploratory data analysis, the effect of log of matric tension
on log of preconsolidation pressure (response variable) can be properly
described by a second order polynomial. Log of preconsolidation pressure
was modelled as a function of soil type, sampling position, soil depth
and log of matric tension. All interactions (until the 4th degree) were
declared. The effect of experimental unit was accounted by random effets
terms in intercept, slope and curvature of the linear mixed effects
model. Likelihood ratio tests were performed to check the relevance
random effects terms and Wald F tests were performed check the relevance
of fixed effect terms, so those not relevant were abandoned getting a
simpler model.

```{r}
# Random intercept.
m0 <- lmer(logppc ~ solo * posi * prof * (logtensao + I(logtensao^2)) +
               (1 | ue1) + (1 | ue2) + (1 | ue3),
           data = da)

# Variance of the random effects.
VarCorr(m0)

# Test for the fixed effect terms of the model.
anova(m0)

# No significant 4 degree interaction.
# No significant 3 degree interaction.
# No significant 2 degree with soil.
# No significant 2 degree with posi.

# Fitting a smaller model with relevant terms.
m1 <- update(m0,
             . ~ (solo + posi + prof) *
                 (logtensao + I(logtensao^2)) +
                 solo:posi +
                 (1 | ue1) + (1 | ue2) + (1 | ue3))
anova(m0, m1)
anova(m1)
```

The model with random effets in the intercept were not inferior, by the
likelihood ratio test, to those more complex that included random
effects for slope and curvature. So, the selected model has random
effects of experimental units on the intercept only.

From this model, by Wald F tests, there weren't 4th degree signficant
interactions neither 3rd degree. There were 2nd degree signficant
interactions involving soil or position at 10%, and involving depth at
less than 1%. All two way interactions were kept except those involving
depth and soil or depth and position. So, depth and soil have additive
effect, the same for depth and position.

## Curve comparison

```{r}
# Estimated marginal means with covariate set at 1.
emm <- emmeans(m1,
               specs = ~solo + posi + prof,
               at = list(logtensao = 1))

# Get experimental points and matrix to calculate marginal means.
grid <- attr(emm, "grid")
L <- attr(emm, "linfct")

# Fixed effects estimates.
b <- fixef(m1)

# Zero order terms (intercept).
ord0 <- names(b) %>%
    grepl(pattern = "logtensao") %>% `!`()

# First order terms (slope).
ord1 <- names(b) %>%
    grepl(pattern = "logtensao$")

# Second order terms (curvatures).
ord2 <- names(b) %>%
    grepl(pattern = "I\\(logtensao\\^2\\)$")

# Get the equation coefficients: b0 + b1 * x + b2 * x^2.
grid$b0 <- c(L %*% (b * ord0))
grid$b1 <- c(L %*% (b * ord1))
grid$b2 <- c(L %*% (b * ord2))

grid <- grid %>%
    mutate(label = sprintf("'%0.2f' %s '%0.3f' * x %s '%0.4f' * x^2",
                           b0,
                           ifelse(b1 >= 0, "+", "-"),
                           abs(b1),
                           ifelse(b2 >= 0, "+", "-"),
                           abs(b2)))


# Table of equation coefficients for each experimental point.
grid
```

The above table has the estimated curve coefficients for each
experimental point resulted of combining soil, position and depth
levels. The fitted curve has equation
$$
  y = \beta_0 + \beta_1 x + \beta_2 x^2
$$
where $y$ is the (conditional mean of) log 10 of preconsolidation
pressure, $x$ is the log 10 of matric tension and $\beta_0$, $\beta_1$
and $\beta_2$ are intercept, slope and curvature parameter of the second
order polynomial.

```{r}
# Conditions to get estimated values.
pred <- with(da,
             expand.grid(solo = levels(solo),
                         posi = levels(posi),
                         prof = levels(prof),
                         logtensao = seq(0.5, 3.5, length = 31),
                         KEEP.OUT.ATTRS = FALSE))

# Model matrix for prediction.
X <- model.matrix(formula(terms(m1))[-2], data = pred)

# Checks.
stopifnot(ncol(X) == length(fixef(m1)))
stopifnot(all(colnames(X) == names(fixef(m1))))

# Predicted value.
pred$fit <- X %*% fixef(m1)

# Standard error of predicted values.
pred$se <- sqrt(diag(X %*% tcrossprod(vcov(m1), X)))

# Quantile of t distribution.
qtl <- qt(p = 0.975, df = df.residual(m1))

# Confidence limits for predicted value.
pred$lwr <- pred$fit - qtl * pred$se
pred$upr <- pred$fit + qtl * pred$se

# Adds the equation to annotate on graphics.
grid <- grid %>%
    mutate(xpos = 2.5,
           ypos = ifelse(solo == "GA", 500, 400) - 30,
           hjust = c(0),
           vjust = c(0))

# Fitted curves with confidence bands and observed data.
# Soil in evidence.
ggplot(data = da,
       mapping = aes(x = tensao, y = ppc, color = solo)) +
    facet_grid(facets = prof ~ posi) +
    geom_point() +
    scale_x_log10() +
    scale_y_log10() +
    geom_line(data = pred,
              mapping = aes(x = 10^logtensao,
                            y = 10^fit,
                            color = solo)) +
    geom_smooth(data = pred,
                mapping = aes(x = 10^logtensao,
                              y = 10^fit,
                              ymin = 10^lwr,
                              ymax = 10^upr),
                stat = "identity",
                show.legend = FALSE) +
    geom_text(data = grid,
              mapping = aes(x = xpos,
                            y = ypos,
                            label = label,
                            hjust = hjust,
                            vjust = vjust),
              show.legend = FALSE,
              parse = TRUE) +
    labs(x = axis_text$tensao,
         y = axis_text$pcc,
         color = axis_text$solo)

grid <- grid %>%
    mutate(xpos = 2.5,
           ypos = ifelse(posi == "Interrow", 500, 400) - 30)

# Fitted curves with confidence bands and observed data.
# Position in evidence.
ggplot(data = da,
       mapping = aes(x = tensao, y = ppc, color = posi)) +
    facet_grid(facets = prof ~ solo) +
    geom_point() +
    scale_x_log10() +
    scale_y_log10() +
    geom_line(data = pred,
              mapping = aes(x = 10^logtensao,
                            y = 10^fit,
                            color = posi)) +
    geom_smooth(data = pred,
                mapping = aes(x = 10^logtensao,
                              y = 10^fit,
                              ymin = 10^lwr,
                              ymax = 10^upr),
                stat = "identity",
                show.legend = FALSE) +
    geom_text(data = grid,
              mapping = aes(x = xpos,
                            y = ypos,
                            label = label,
                            hjust = hjust,
                            vjust = vjust),
              show.legend = FALSE,
              parse = TRUE) +
    labs(x = axis_text$tensao,
         y = axis_text$pcc,
         color = axis_text$posi)
```

The above graphics displays the estimated quadratic curve fitted (solid
line) in each combination of soil, position and depth to describe log of
preconsolidation pressure as a function of log matric tension. The
shaded region wrapping the estimated curve is the confidence band for
the fitted conditional mean. The equations inside each cell plot are in
log-log scale. By visualizing the curves, we notice that the predicted
value for each soil differ at most part of the matric tension
domain. The difference is greater in the interrow position than in row,
as stated by the R test previous applied. The difference is the same in
all depth at the same position level, since there wasn't 3rd degree
interaction involving soil, position and depth.

```{r}
# Tests of soil curves are equal in each posi:prof combination.
grid %>%
    mutate(row = 1:n()) %>%
    group_by(posi, prof) %>%
    do({
        compare_curves(.$row, .$solo, L, list(ord0, ord1, ord2))
    }) %>%
    as.data.frame()

# Tests of posi curves are equal in each soil:prof combination.
grid %>%
    mutate(row = 1:n()) %>%
    group_by(solo, prof) %>%
    do({
        compare_curves(.$row, .$posi, L, list(ord0, ord1, ord2))
    }) %>%
    as.data.frame()
```

Wald F test were applied to test with two curves are equal. The null
hypothesis states that all three parameters ($\beta_0$, $\beta_1$,
$\beta_2$) are simultaneous equal for a pair of curves
$$
  H_0:
  \begin{bmatrix} \beta_0 \\ \beta_1 \\ \beta_2 \end{bmatrix} =
  \begin{bmatrix} \beta_0' \\ \beta_1' \\ \beta_2' \end{bmatrix}.
$$

The tables above shows the F statistics and associate p-value to test
the equality of two curves using the Wald test. Curves from soils were
compared for each position and depth combination (6 conditions). Because
there wasn't 3rd order interaction, the F statistic is the same for all
depth at the same position. The greater difference, as showed by the
curves on the next graphics, is between soil curves at interrow
position.

The same test were applied to test equality of curves between position
for each soil and depth combination (6 conditions). Because there wasn't
3rd order interaction, the F statistic is the same for all depth at the
same soil. The greater difference, as showed by the
curves on the next graphics, is between position curves at GA
soil. Despite the overlapping of confidence bands between position in
the KH soil, according two the F test, these curves are not equal at 5%.

## Session information

```{r, echo = FALSE, results = "hold"}
cat(format(Sys.time(),
           format = "Atualizado em %d de %B de %Y.\n\n"))
sessionInfo()
```
